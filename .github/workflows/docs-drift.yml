name: Docs Drift Check

on:
  pull_request:
    branches: [ main ]
    paths:
      - "docs/**"
      - "src/**"
      - "bin/**"
      - "pyproject.toml"
      - "README.md"
      - ".github/workflows/docs-drift.yml"

jobs:
  audit:
    name: Docs Drift Check / audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -U pip
      - run: python tools/doc_drift_audit.py
      - name: Fail on drift (high confidence)
        run: |
          python - <<'PY'
          import json, sys, pathlib
          p = pathlib.Path("docs/_build/doc_drift_report.json")
          rep = json.loads(p.read_text()) if p.exists() else {}
          missing = rep.get("missing_in_docs", {}).get("outputs", [])
          # Fail only for the critical ones
          critical = [x for x in missing if x in ["_merged_pixel_extraction.parquet","_qa.png"]]
          if critical:
              print("Doc drift detected for critical outputs:", critical)
              sys.exit(1)
          PY
