
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the Cross-Sensor Calibration pipeline that processes NEON AOP hyperspectral flightlines into analysis-ready products.">
      
      
      
        <link rel="canonical" href="https://earthlab.github.io/cross-sensor-cal/pipeline/">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Pipeline reference - cross-sensor-cal</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pipeline-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="cross-sensor-cal" class="md-header__button md-logo" aria-label="cross-sensor-cal" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            cross-sensor-cal
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pipeline reference
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/earthlab/cross-sensor-cal" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="cross-sensor-cal" class="md-nav__button md-logo" aria-label="cross-sensor-cal" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    cross-sensor-cal
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/earthlab/cross-sensor-cal" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pipeline
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Pipeline
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="stages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="outputs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Outputs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="qa_panel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    QA Panel
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI & Examples
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/merge_duckdb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    merge_duckdb
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/qa_plots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    qa_plots
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Dev
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Dev
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dev/contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dev/doc_drift_report/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Doc Drift Report
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#canonical-paths-via-get_flight_paths" class="md-nav__link">
    <span class="md-ellipsis">
      Canonical paths via get_flight_paths()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stage-by-stage-details" class="md-nav__link">
    <span class="md-ellipsis">
      Stage-by-stage details
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Stage-by-stage details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0-download-neon-hdf5" class="md-nav__link">
    <span class="md-ellipsis">
      0. Download NEON HDF5
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-envi-export" class="md-nav__link">
    <span class="md-ellipsis">
      1. ENVI export
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-build-correction-json" class="md-nav__link">
    <span class="md-ellipsis">
      2. Build correction JSON
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-brdf-topographic-correction" class="md-nav__link">
    <span class="md-ellipsis">
      3. BRDF + topographic correction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-sensor-convolution-resampling" class="md-nav__link">
    <span class="md-ellipsis">
      4. Sensor convolution / resampling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-run-transcript" class="md-nav__link">
    <span class="md-ellipsis">
      Example run transcript
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Example run transcript">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parallel-flightline-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Parallel flightline execution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rerun-guidance" class="md-nav__link">
    <span class="md-ellipsis">
      Rerun guidance
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/earthlab/cross-sensor-cal/edit/master/docs/pipeline.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="pipeline-reference">Pipeline reference<a class="headerlink" href="#pipeline-reference" title="Permanent link">&para;</a></h1>
<p>Cross-Sensor Calibration orchestrates the same five ordered stages for every
flight line. Each stage consults <code>get_flight_paths()</code> to locate its inputs,
per-flightline working directory, and outputs, validates artifacts before
working, and emits emoji-rich logs that make the restart-safe behavior explicit.
All persistent products land inside <code>&lt;base_folder&gt;/&lt;flight_stem&gt;/</code> (with the raw
<code>.h5</code> kept at the base root) and include ENVI (<code>.img/.hdr</code>), JSON metadata, and
Parquet summaries.</p>
<h2 id="canonical-paths-via-get_flight_paths">Canonical paths via <code>get_flight_paths()</code><a class="headerlink" href="#canonical-paths-via-get_flight_paths" title="Permanent link">&para;</a></h2>
<p><code>get_flight_paths(base_folder, flight_stem)</code> is the authoritative source of
truth for every artifact the pipeline reads or writes. For a flight line with
stem <code>&lt;flight_stem&gt;</code> it yields:</p>
<ul>
<li><code>h5_path</code> → <code>&lt;base_folder&gt;/&lt;flight_stem&gt;.h5</code></li>
<li><code>work_dir</code> → <code>&lt;base_folder&gt;/&lt;flight_stem&gt;/</code></li>
<li><code>raw_envi_img</code> / <code>raw_envi_hdr</code> → <code>&lt;flight_stem&gt;_envi.img</code> and
  <code>&lt;flight_stem&gt;_envi.hdr</code> inside <code>work_dir</code></li>
<li><code>correction_json</code> → <code>&lt;flight_stem&gt;_brdfandtopo_corrected_envi.json</code> in
  <code>work_dir</code></li>
<li><code>corrected_img</code> / <code>corrected_hdr</code> →
  <code>&lt;flight_stem&gt;_brdfandtopo_corrected_envi.img</code> and
  <code>&lt;flight_stem&gt;_brdfandtopo_corrected_envi.hdr</code></li>
<li><code>sensor_products</code> → a dict mapping each sensor (e.g. <code>landsat_tm</code>,
  <code>landsat_etm+</code>, <code>landsat_oli</code>, <code>landsat_oli2</code>, <code>micasense</code>) to
  <code>&lt;flight_stem&gt;_&lt;sensor_name&gt;_envi.img</code> /
  <code>&lt;flight_stem&gt;_&lt;sensor_name&gt;_envi.hdr</code></li>
<li><code>parquet_products</code> → optional Parquet summaries colocated with their source
  rasters</li>
</ul>
<p>All stages request their expected paths from this function and refuse to invent
filenames on the fly. If naming ever changes, update <code>get_flight_paths()</code> once
rather than editing every stage.</p>
<h2 id="stage-by-stage-details">Stage-by-stage details<a class="headerlink" href="#stage-by-stage-details" title="Permanent link">&para;</a></h2>
<p>Every stage is restart-safe: it skips itself when valid outputs already exist.
Validation requires both sides of an ENVI pair to exist and be non-empty or, for
JSON, the file must parse successfully. When a stage skips, it logs a <code>✅ ...
(skipping)</code> message; otherwise it performs work and logs what it produced. Live
tqdm progress bars accompany downloads, ENVI chunk exports, and BRDF+topo
corrections.</p>
<h3 id="0-download-neon-hdf5">0. Download NEON HDF5<a class="headerlink" href="#0-download-neon-hdf5" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Inputs</strong></li>
<li>NEON site code, product code, and flight stem.</li>
<li><strong>Outputs</strong></li>
<li><code>&lt;base_folder&gt;/&lt;flight_stem&gt;.h5</code> (left in the workspace root).</li>
<li><strong>Skip criteria</strong></li>
<li>Existing <code>.h5</code> file that passes a size/metadata sanity check.</li>
<li><strong>Logging</strong></li>
<li>Logs <code>📥 stage_download_h5()</code> with a streaming byte counter while downloading.</li>
<li>On skip emits <code>✅ stage_download_h5() found existing .h5 (skipping)</code>.</li>
<li><strong>Failure handling</strong></li>
<li>Raises on HTTP errors or truncated downloads; reruns resume by revalidating the file.</li>
</ul>
<h3 id="1-envi-export">1. ENVI export<a class="headerlink" href="#1-envi-export" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Inputs</strong></li>
<li>NEON directional reflectance cube (<code>&lt;flight_stem&gt;.h5</code>).</li>
<li><strong>Outputs</strong></li>
<li><code>&lt;flight_stem&gt;/&lt;flight_stem&gt;_envi.img</code></li>
<li><code>&lt;flight_stem&gt;/&lt;flight_stem&gt;_envi.hdr</code></li>
<li><strong>Extras</strong></li>
<li><code>&lt;flight_stem&gt;/&lt;flight_stem&gt;_envi.parquet</code> (summary statistics per tile).</li>
<li><strong>Skip criteria</strong></li>
<li>Both ENVI files exist, are non-empty, and pass the internal ENVI validation.</li>
<li><strong>Logging</strong></li>
<li>Always logs <code>🔎 ENVI export target for &lt;flight_stem&gt; is ..._envi.img / ..._envi.hdr</code> with a chunked progress bar.</li>
<li>On skip emits
    <code>✅ ENVI export already complete for &lt;flight_stem&gt; -&gt; ..._envi.img / ..._envi.hdr (skipping heavy export)</code>.</li>
<li>Otherwise streams progress as tiles are written and logs success.</li>
<li><strong>Failure handling</strong></li>
<li>Errors here stop the stage; reruns regenerate if outputs were missing or invalid.</li>
</ul>
<h3 id="2-build-correction-json">2. Build correction JSON<a class="headerlink" href="#2-build-correction-json" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Inputs</strong></li>
<li>Uncorrected ENVI pair from stage 1.</li>
<li><strong>Output</strong></li>
<li><code>&lt;flight_stem&gt;/&lt;flight_stem&gt;_brdfandtopo_corrected_envi.json</code></li>
<li><strong>Skip criteria</strong></li>
<li>JSON exists and parses.</li>
<li><strong>Logging</strong></li>
<li>On skip logs
    <code>✅ Correction JSON already complete for &lt;flight_stem&gt; -&gt; ..._brdfandtopo_corrected_envi.json (skipping)</code>.</li>
<li>Otherwise logs that it is computing parameters and then writing the JSON.</li>
<li><strong>Failure handling</strong></li>
<li>Failures propagate so that reruns recompute the JSON before downstream stages continue.</li>
</ul>
<h3 id="3-brdf-topographic-correction">3. BRDF + topographic correction<a class="headerlink" href="#3-brdf-topographic-correction" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Inputs</strong></li>
<li>Uncorrected ENVI pair.</li>
<li>Correction JSON from stage 2.</li>
<li><strong>Outputs</strong></li>
<li><code>&lt;flight_stem&gt;/&lt;flight_stem&gt;_brdfandtopo_corrected_envi.img</code></li>
<li><code>&lt;flight_stem&gt;/&lt;flight_stem&gt;_brdfandtopo_corrected_envi.hdr</code></li>
<li><strong>Extras</strong></li>
<li><code>&lt;flight_stem&gt;/&lt;flight_stem&gt;_brdfandtopo_corrected_envi.parquet</code></li>
<li><strong>Skip criteria</strong></li>
<li>Corrected ENVI pair exists, is non-empty, and validates.</li>
<li><strong>Logging</strong></li>
<li>On skip logs
    <code>✅ BRDF+topo correction already complete for &lt;flight_stem&gt; -&gt; ..._brdfandtopo_corrected_envi.img / ..._brdfandtopo_corrected_envi.hdr (skipping)</code>.</li>
<li>When recomputing, streams a chunk progress bar while writing and logs completion.</li>
<li><strong>Failure handling</strong></li>
<li>Failures raise immediately because the corrected cube is the canonical science product.
    Reruns recompute just this stage if its outputs were missing or corrupt.</li>
</ul>
<h3 id="4-sensor-convolution-resampling">4. Sensor convolution / resampling<a class="headerlink" href="#4-sensor-convolution-resampling" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Inputs</strong></li>
<li>Corrected ENVI pair from stage 3. This stage never reads the raw <code>.h5</code>.</li>
<li>Sensor spectral response library bundled with the project.</li>
<li><strong>Outputs</strong></li>
<li>For each known sensor, an ENVI pair following
    <code>&lt;flight_stem&gt;/&lt;flight_stem&gt;_&lt;sensor_name&gt;_envi.img</code> /
    <code>&lt;flight_stem&gt;/&lt;flight_stem&gt;_&lt;sensor_name&gt;_envi.hdr</code> (e.g.
    <code>.../NEON_D13_NIWO_DP1_L019-1_20230815_directional_reflectance_landsat_tm_envi.img</code>).</li>
<li><strong>Extras</strong></li>
<li>Optional Parquet tables named <code>&lt;flight_stem&gt;_&lt;sensor_name&gt;_envi.parquet</code> in
    the same folder.</li>
<li><strong>Skip criteria</strong></li>
<li>Individual sensor ENVI pairs that already exist and validate are skipped and reported.</li>
<li><strong>Logging</strong></li>
<li>Begins with <code>🎯 Convolving corrected reflectance for &lt;flight_stem&gt;</code>.</li>
<li>On fresh generation logs
    <code>✅ Wrote &lt;sensor_name&gt; product for &lt;flight_stem&gt; -&gt; ..._envi.img / ..._envi.hdr</code>.</li>
<li>On skip logs
    <code>✅ &lt;sensor_name&gt; product already complete for &lt;flight_stem&gt; -&gt; ... (skipping)</code>.</li>
<li>Ends with
    <code>📊 Sensor convolution summary for &lt;flight_stem&gt; | succeeded=[...] skipped=[...] failed=[...]</code>
    followed by <code>🎉 Finished pipeline for &lt;flight_stem&gt;</code>.</li>
<li><strong>Failure handling</strong></li>
<li>Sensors are processed independently. Missing definitions or write failures mark that
    sensor as <code>failed</code> but do not abort the stage unless <em>all</em> sensors fail and none were
    previously valid. Partial success is acceptable.</li>
</ul>
<h2 id="example-run-transcript">Example run transcript<a class="headerlink" href="#example-run-transcript" title="Permanent link">&para;</a></h2>
<p>The restart-safe logs surface the exact work performed. A real rerun for one
flight line now looks like:</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">NEON_D13_NIWO_DP1_L019</span><span class="o">-</span><span class="mi">1</span><span class="n">_20230815_directional_reflectance</span><span class="p">]</span><span class="w"> </span><span class="err">🚀</span><span class="w"> </span><span class="n">Processing</span><span class="w"> </span><span class="o">...</span>
<span class="p">[</span><span class="n">NEON_D13_NIWO_DP1_L019</span><span class="o">-</span><span class="mi">1</span><span class="n">_20230815_directional_reflectance</span><span class="p">]</span><span class="w"> </span><span class="err">📥</span><span class="w"> </span><span class="n">stage_download_h5</span><span class="p">()</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="n">existing</span><span class="w"> </span><span class="o">.</span><span class="n">h5</span><span class="w"> </span><span class="p">(</span><span class="n">skipping</span><span class="p">)</span>
<span class="p">[</span><span class="n">NEON_D13_NIWO_DP1_L019</span><span class="o">-</span><span class="mi">1</span><span class="n">_20230815_directional_reflectance</span><span class="p">]</span><span class="w"> </span><span class="err">🔎</span><span class="w"> </span><span class="n">ENVI</span><span class="w"> </span><span class="k">export</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="o">...</span><span class="n">_envi</span><span class="o">.</span><span class="n">img</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">...</span><span class="n">_envi</span><span class="o">.</span><span class="n">hdr</span>
<span class="p">[</span><span class="n">NEON_D13_NIWO_DP1_L019</span><span class="o">-</span><span class="mi">1</span><span class="n">_20230815_directional_reflectance</span><span class="p">]</span><span class="w"> </span><span class="err">✅</span><span class="w"> </span><span class="n">ENVI</span><span class="w"> </span><span class="k">export</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">complete</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">...</span><span class="n">_envi</span><span class="o">.</span><span class="n">img</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">...</span><span class="n">_envi</span><span class="o">.</span><span class="n">hdr</span><span class="w"> </span><span class="p">(</span><span class="n">skipping</span><span class="w"> </span><span class="n">heavy</span><span class="w"> </span><span class="k">export</span><span class="p">)</span>
<span class="p">[</span><span class="n">NEON_D13_NIWO_DP1_L019</span><span class="o">-</span><span class="mi">1</span><span class="n">_20230815_directional_reflectance</span><span class="p">]</span><span class="w"> </span><span class="err">✅</span><span class="w"> </span><span class="n">Correction</span><span class="w"> </span><span class="n">JSON</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">complete</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">...</span><span class="n">_brdfandtopo_corrected_envi</span><span class="o">.</span><span class="n">json</span><span class="w"> </span><span class="p">(</span><span class="n">skipping</span><span class="p">)</span>
<span class="p">[</span><span class="n">NEON_D13_NIWO_DP1_L019</span><span class="o">-</span><span class="mi">1</span><span class="n">_20230815_directional_reflectance</span><span class="p">]</span><span class="w"> </span><span class="err">✅</span><span class="w"> </span><span class="n">BRDF</span><span class="o">+</span><span class="n">topo</span><span class="w"> </span><span class="n">correction</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">complete</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">...</span><span class="n">_brdfandtopo_corrected_envi</span><span class="o">.</span><span class="n">img</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">...</span><span class="n">_brdfandtopo_corrected_envi</span><span class="o">.</span><span class="n">hdr</span><span class="w"> </span><span class="p">(</span><span class="n">skipping</span><span class="p">)</span>
<span class="p">[</span><span class="n">NEON_D13_NIWO_DP1_L019</span><span class="o">-</span><span class="mi">1</span><span class="n">_20230815_directional_reflectance</span><span class="p">]</span><span class="w"> </span><span class="err">🎯</span><span class="w"> </span><span class="n">Convolving</span><span class="w"> </span><span class="n">corrected</span><span class="w"> </span><span class="n">reflectance</span>
<span class="p">[</span><span class="n">NEON_D13_NIWO_DP1_L019</span><span class="o">-</span><span class="mi">1</span><span class="n">_20230815_directional_reflectance</span><span class="p">]</span><span class="w"> </span><span class="err">✅</span><span class="w"> </span><span class="n">Wrote</span><span class="w"> </span><span class="n">landsat_tm</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">...</span><span class="n">_landsat_tm_envi</span><span class="o">.</span><span class="n">img</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">...</span><span class="n">_landsat_tm_envi</span><span class="o">.</span><span class="n">hdr</span>
<span class="p">[</span><span class="n">NEON_D13_NIWO_DP1_L019</span><span class="o">-</span><span class="mi">1</span><span class="n">_20230815_directional_reflectance</span><span class="p">]</span><span class="w"> </span><span class="err">✅</span><span class="w"> </span><span class="n">Wrote</span><span class="w"> </span><span class="n">micasense</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">...</span><span class="n">_micasense_envi</span><span class="o">.</span><span class="n">img</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">...</span><span class="n">_micasense_envi</span><span class="o">.</span><span class="n">hdr</span>
<span class="p">[</span><span class="n">NEON_D13_NIWO_DP1_L019</span><span class="o">-</span><span class="mi">1</span><span class="n">_20230815_directional_reflectance</span><span class="p">]</span><span class="w"> </span><span class="err">📊</span><span class="w"> </span><span class="n">Sensor</span><span class="w"> </span><span class="n">convolution</span><span class="w"> </span><span class="n">summary</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">succeeded</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;landsat_tm&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;micasense&#39;</span><span class="p">]</span><span class="w"> </span><span class="n">skipped</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;landsat_etm+&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;landsat_oli&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;landsat_oli2&#39;</span><span class="p">]</span><span class="w"> </span><span class="n">failed</span><span class="o">=</span><span class="p">[]</span>
<span class="p">[</span><span class="n">NEON_D13_NIWO_DP1_L019</span><span class="o">-</span><span class="mi">1</span><span class="n">_20230815_directional_reflectance</span><span class="p">]</span><span class="w"> </span><span class="err">🎉</span><span class="w"> </span><span class="n">Finished</span><span class="w"> </span><span class="n">pipeline</span>
</code></pre></div>

<h3 id="parallel-flightline-execution">Parallel flightline execution<a class="headerlink" href="#parallel-flightline-execution" title="Permanent link">&para;</a></h3>
<p>After all downloads succeed, <code>go_forth_and_multiply()</code> dispatches each
flightline to a <code>ThreadPoolExecutor</code>. The <code>max_workers</code> argument controls the
level of concurrency; leave it <code>None</code> to process sequentially. <code>_scoped_log_prefix()</code>
prepends <code>[flight_stem]</code> to every log so parallel runs stay readable, and each
worker writes only within its own <code>&lt;base&gt;/&lt;flight_stem&gt;/</code> directory to preserve
idempotence.</p>
<p>When <code>go_forth_and_multiply(...)</code> finishes looping over every requested flight
line it logs <code>✅ All requested flightlines processed.</code> to confirm site-level
completion.</p>
<h2 id="rerun-guidance">Rerun guidance<a class="headerlink" href="#rerun-guidance" title="Permanent link">&para;</a></h2>
<p>Call <code>go_forth_and_multiply(...)</code> with the same parameters to rerun an entire
site-month. The restart-safe checks ensure that valid artifacts are reused,
missing or invalid stages are recomputed, and partial sensor failures do not
stop progress across the rest of the flight lines. Because each sensor is
accounted for independently, you can inspect the summary lists to see exactly
which products succeeded, which were reused, and which need attention.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "content.code.copy", "content.action.edit"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>